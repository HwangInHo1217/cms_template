<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>공지사항 작성</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.ckeditor.com/4.16.2/standard/ckeditor.js"></script>
<style>
    body {
        font-family: 'Malgun Gothic', sans-serif;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        min-height: 100vh;
    }
    
    .main-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 1rem 0;
        margin-bottom: 2rem;
    }
    
    .content-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .form-section {
        margin-bottom: 2rem;
    }
    
    .form-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .category-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .badge-important {
        background: #dc3545;
        color: white;
    }
    
    .badge-urgent {
        background: #fd7e14;
        color: white;
    }
    
    .badge-general {
        background: #0d6efd;
        color: white;
    }
    
    .badge-event {
        background: #198754;
        color: white;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        justify-content: between;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    
    .file-item .file-name {
        flex-grow: 1;
        margin-left: 0.5rem;
    }
    
    .file-item .file-size {
        color: #6c757d;
        font-size: 0.8rem;
        margin-right: 1rem;
    }
    
    .notice-options {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .option-title {
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .option-section {
        margin-bottom: 1.5rem;
    }
    
    .option-label {
        font-size: 0.9rem;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .access-badge {
        background: #6c757d;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-left: 0.5rem;
    }
    
    .summernote-container {
        margin-bottom: 1rem;
    }
    
    .note-editor {
        border-radius: 0.375rem;
    }
    
    .draft-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .draft-item {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }
    
    .draft-title {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .draft-date {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .notice-history {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .history-item {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .history-title {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .history-date {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .history-status {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
    }
    
    .status-published {
        background: #d1e7dd;
        color: #0f5132;
    }
    
    .status-draft {
        background: #e2e3e5;
        color: #41464b;
    }
    
    @media (max-width: 768px) {
        .preview-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }

    .ckeditor-container {
        margin-bottom: 1rem;
    }
</style>
</head>
<body>
<!-- 헤더 -->
<div class="main-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="text-white mb-0">
                    <i class="bi bi-pencil-square"></i> 공지사항 작성
                    <span class="access-badge">교직원 전용</span>
                </h1>
            </div>
            <div class="col-md-6 text-md-end">
                <button class="btn btn-outline-light" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> 뒤로가기
                </button>
                <button class="btn btn-outline-light ms-2" onclick="viewNoticeList()">
                    <i class="bi bi-list-ul"></i> 공지사항 목록
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <!-- 공지사항 작성 폼 -->
            <div class="content-card">
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-info-circle"></i> 기본 정보
                    </div>
                    <div class="mb-3">
                        <label for="noticeTitle" class="form-label">제목 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="noticeTitle" placeholder="공지사항 제목을 입력하세요" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="noticeCategory" class="form-label">분류 <span class="text-danger">*</span></label>
                            <select class="form-select" id="noticeCategory" required onchange="updatePreview()">
                                <option value="">선택하세요</option>
                                <option value="important">중요</option>
                                <option value="urgent">긴급</option>
                                <option value="general">일반</option>
                                <option value="event">행사</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="noticeTarget" class="form-label">대상</label>
                            <select class="form-select" id="noticeTarget">
                                <option value="all">전체</option>
                                <option value="freshman">1학년</option>
                                <option value="sophomore">2학년</option>
                                <option value="junior">3학년</option>
                                <option value="senior">4학년</option>
                                <option value="computer">컴퓨터공학과</option>
                                <option value="business">경영학과</option>
                                <option value="mechanical">기계공학과</option>
                                <option value="english">영어영문학과</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-file-text"></i> 내용 작성
                    </div>
                    <div class="ckeditor-container">
                        <textarea id="noticeContent" name="noticeContent"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <i class="bi bi-paperclip"></i> 첨부파일
                    </div>
                    <div class="mb-3">
                        <input class="form-control" type="file" id="noticeFiles" multiple>
                    </div>
                    <div id="fileList" class="mt-3">
                        <!-- 첨부파일 목록이 여기에 표시됩니다 -->
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <button class="btn btn-secondary" onclick="saveDraft()">
                            <i class="bi bi-save"></i> 임시저장
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary me-2" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise"></i> 초기화
                        </button>
                        <button class="btn btn-primary" onclick="publishNotice()">
                            <i class="bi bi-send"></i> 공지사항 등록
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- 옵션 패널 -->
            <div class="notice-options">
                <div class="option-title">
                    <i class="bi bi-gear"></i> 공지사항 옵션
                </div>
                
                <div class="option-section">
                    <div class="option-label">게시 설정</div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="optionPinned">
                        <label class="form-check-label" for="optionPinned">
                            상단 고정
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="optionSendEmail">
                        <label class="form-check-label" for="optionSendEmail">
                            이메일로 알림 발송
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="optionRequireConfirm">
                        <label class="form-check-label" for="optionRequireConfirm">
                            학생 확인 필수
                        </label>
                    </div>
                </div>
                
                <div class="option-section">
                    <div class="option-label">작성자 정보</div>
                    <div class="mb-2">
                        <label for="authorName" class="form-label">작성자</label>
                        <input type="text" class="form-control" id="authorName" value="김관리" readonly>
                    </div>
                    <div class="mb-2">
                        <label for="authorDepartment" class="form-label">부서</label>
                        <input type="text" class="form-control" id="authorDepartment" value="교무처" readonly>
                    </div>
                </div>
            </div>

            <!-- 임시저장 목록 -->
            <div class="content-card">
                <h5 class="mb-3"><i class="bi bi-archive"></i> 임시저장 목록</h5>
                <div class="draft-list" id="draftList">
                    <!-- 임시저장 목록이 여기에 표시됩니다 -->
                </div>
            </div>

            <!-- 최근 작성 내역 -->
            <div class="content-card">
                <h5 class="mb-3"><i class="bi bi-clock-history"></i> 최근 작성 내역</h5>
                <div class="notice-history" id="noticeHistory">
                    <!-- 최근 작성 내역이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 공지사항 등록 확인 모달 -->
<div class="modal fade" id="publishModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">공지사항 등록 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>작성한 공지사항을 등록하시겠습니까?</p>
                <p class="text-muted">등록 후에는 학생들에게 즉시 공개됩니다.</p>
                
                <div class="alert alert-info">
                    <div class="mb-2"><strong>제목:</strong> <span id="confirmTitle"></span></div>
                    <div class="mb-2"><strong>분류:</strong> <span id="confirmCategory"></span></div>
                    <div><strong>대상:</strong> <span id="confirmTarget"></span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="confirmPublish()">등록</button>
            </div>
        </div>
    </div>
</div>

<!-- 임시저장 완료 토스트 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="draftToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            <strong class="me-auto">임시저장 완료</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            공지사항이 임시저장되었습니다.
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 임시저장 데이터
    let drafts = [
        {
            id: 1,
            title: "2024년 2학기 장학금 신청 안내 (임시)",
            category: "important",
            target: "all",
            content: "2024년 2학기 장학금 신청 관련 임시 내용입니다.",
            date: "2024-04-15"
        },
        {
            id: 2,
            title: "도서관 이용시간 변경 안내 (초안)",
            category: "general",
            target: "all",
            content: "도서관 이용시간 변경 관련 초안입니다.",
            date: "2024-04-10"
        }
    ];

    // 최근 작성 내역
    let history = [
        {
            id: 1,
            title: "2024년 1학기 핵심역량 진단 실시 안내",
            category: "important",
            date: "2024-04-01",
            status: "published"
        },
        {
            id: 2,
            title: "시스템 점검으로 인한 일시 서비스 중단 안내",
            category: "urgent",
            date: "2024-04-10",
            status: "published"
        },
        {
            id: 3,
            title: "2024년 하계 방학 기숙사 신청 안내",
            category: "general",
            date: "2024-04-05",
            status: "draft"
        }
    ];

    // 첨부파일 목록
    let attachedFiles = [];

    // 페이지 로드 시 초기화
    $(document).ready(function() {
        CKEDITOR.replace('noticeContent', {
            height: 300,
            filebrowserUploadUrl: '/upload',
            filebrowserUploadMethod: 'form',
            removePlugins: 'elementspath',
            resize_enabled: false,
            toolbarGroups: [
                { name: 'document', groups: ['mode', 'document', 'doctools'] },
                { name: 'clipboard', groups: ['clipboard', 'undo'] },
                { name: 'editing', groups: ['find', 'selection', 'spellchecker', 'editing'] },
                { name: 'forms', groups: ['forms'] },
                '/',
                { name: 'basicstyles', groups: ['basicstyles', 'cleanup'] },
                { name: 'paragraph', groups: ['list', 'indent', 'blocks', 'align', 'bidi', 'paragraph'] },
                { name: 'links', groups: ['links'] },
                { name: 'insert', groups: ['insert'] },
                '/',
                { name: 'styles', groups: ['styles'] },
                { name: 'colors', groups: ['colors'] },
                { name: 'tools', groups: ['tools'] },
                { name: 'others', groups: ['others'] },
                { name: 'about', groups: ['about'] }
            ]
        });

        // 현재 날짜 설정
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('publishDate').value = today;
        
        // 임시저장 목록 렌더링
        renderDrafts();
        
        // 작성 내역 렌더링
        renderHistory();
        
        // 파일 입력 이벤트
        $('#noticeFiles').on('change', function(e) {
            handleFileSelect(e);
        });
    });

    // 파일 선택 처리
    function handleFileSelect(event) {
        const files = event.target.files;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileSize = formatFileSize(file.size);
            
            attachedFiles.push({
                name: file.name,
                size: fileSize,
                file: file
            });
        }
        
        renderFileList();
    }

    // 파일 크기 포맷
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 파일 목록 렌더링
    function renderFileList() {
        const fileList = $('#fileList');
        fileList.empty();
        
        if (attachedFiles.length === 0) {
            fileList.html('<p class="text-muted">첨부된 파일이 없습니다.</p>');
            return;
        }
        
        attachedFiles.forEach((file, index) => {
            const fileItem = `
                <div class="file-item">
                    <i class="bi bi-file-earmark"></i>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${file.size}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            fileList.append(fileItem);
        });
    }

    // 파일 제거
    function removeFile(index) {
        attachedFiles.splice(index, 1);
        renderFileList();
    }

    // 임시저장 목록 렌더링
    function renderDrafts() {
        const draftList = $('#draftList');
        draftList.empty();
        
        if (drafts.length === 0) {
            draftList.html('<p class="text-muted text-center py-3">임시저장된 공지사항이 없습니다.</p>');
            return;
        }
        
        drafts.forEach(draft => {
            const draftItem = `
                <div class="draft-item" onclick="loadDraft(${draft.id})">
                    <div class="draft-title">${draft.title}</div>
                    <div class="draft-date">${draft.date}</div>
                </div>
            `;
            draftList.append(draftItem);
        });
    }

    // 작성 내역 렌더링
    function renderHistory() {
        const historyList = $('#noticeHistory');
        historyList.empty();
        
        if (history.length === 0) {
            historyList.html('<p class="text-muted text-center py-3">작성 내역이 없습니다.</p>');
            return;
        }
        
        history.forEach(item => {
            const statusClass = item.status === 'published' ? 'status-published' : 'status-draft';
            const statusText = item.status === 'published' ? '게시됨' : '임시저장';
            
            const historyItem = `
                <div class="history-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="history-title">${item.title}</div>
                        <span class="history-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="history-date">${item.date}</div>
                </div>
            `;
            historyList.append(historyItem);
        });
    }

    // 임시저장 불러오기
    function loadDraft(id) {
        const draft = drafts.find(d => d.id === id);
        if (!draft) return;
        
        $('#noticeTitle').val(draft.title);
        $('#noticeCategory').val(draft.category);
        $('#noticeTarget').val(draft.target);
        CKEDITOR.instances.noticeContent.setData(draft.content);
        
        showToast('임시저장된 공지사항을 불러왔습니다.');
    }

    // 임시저장
    function saveDraft() {
        const title = $('#noticeTitle').val();
        if (!title) {
            alert('제목을 입력해주세요.');
            return;
        }
        
        const content = CKEDITOR.instances.noticeContent.getData();
        const category = $('#noticeCategory').val() || 'general';
        const target = $('#noticeTarget').val() || 'all';
        
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        
        const newDraft = {
            id: drafts.length > 0 ? Math.max(...drafts.map(d => d.id)) + 1 : 1,
            title: title,
            category: category,
            target: target,
            content: content,
            date: formattedDate
        };
        
        drafts.unshift(newDraft);
        renderDrafts();
        
        // 토스트 표시
        const draftToast = new bootstrap.Toast(document.getElementById('draftToast'));
        draftToast.show();
    }

    // 공지사항 등록
    function publishNotice() {
        const title = $('#noticeTitle').val();
        const category = $('#noticeCategory').val();
        
        if (!title) {
            alert('제목을 입력해주세요.');
            return;
        }
        
        if (!category) {
            alert('분류를 선택해주세요.');
            return;
        }
        
        const content = CKEDITOR.instances.noticeContent.getData();
        if (!content || content === '<p><br></p>') {
            alert('내용을 입력해주세요.');
            return;
        }
        
        // 확인 모달에 정보 설정
        $('#confirmTitle').text(title);
        
        let categoryText = '일반';
        switch(category) {
            case 'important': categoryText = '중요'; break;
            case 'urgent': categoryText = '긴급'; break;
            case 'event': categoryText = '행사'; break;
            default: categoryText = '일반';
        }
        $('#confirmCategory').text(categoryText);
        
        const target = $('#noticeTarget').val() || 'all';
        let targetText = '전체';
        switch(target) {
            case 'freshman': targetText = '1학년'; break;
            case 'sophomore': targetText = '2학년'; break;
            case 'junior': targetText = '3학년'; break;
            case 'senior': targetText = '4학년'; break;
            case 'computer': targetText = '컴퓨터공학과'; break;
            case 'business': targetText = '경영학과'; break;
            case 'mechanical': targetText = '기계공학과'; break;
            case 'english': targetText = '영어영문학과'; break;
            default: targetText = '전체';
        }
        $('#confirmTarget').text(targetText);
        
        // 확인 모달 표시
        const publishModal = new bootstrap.Modal(document.getElementById('publishModal'));
        publishModal.show();
    }

    // 공지사항 등록 확인
    function confirmPublish() {
        // 여기서 실제 등록 처리를 수행합니다.
        // 서버에 데이터를 전송하는 코드가 들어갑니다.
        
        // 모달 닫기
        bootstrap.Modal.getInstance(document.getElementById('publishModal')).hide();
        
        // 성공 메시지 표시
        alert('공지사항이 성공적으로 등록되었습니다.');
        
        // 폼 초기화
        resetForm();
        
        // 작성 내역에 추가
        const title = $('#noticeTitle').val();
        const category = $('#noticeCategory').val();
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        
        const newHistory = {
            id: history.length > 0 ? Math.max(...history.map(h => h.id)) + 1 : 1,
            title: title,
            category: category,
            date: formattedDate,
            status: 'published'
        };
        
        history.unshift(newHistory);
        renderHistory();
    }

    // 폼 초기화
    function resetForm() {
        $('#noticeTitle').val('');
        $('#noticeCategory').val('');
        $('#noticeTarget').val('all');
        CKEDITOR.instances.noticeContent.setData('');
        
        // 첨부파일 초기화
        $('#noticeFiles').val('');
        attachedFiles = [];
        renderFileList();
        
        // 옵션 초기화
        $('#optionPinned').prop('checked', false);
        $('#optionSendEmail').prop('checked', false);
        $('#optionRequireConfirm').prop('checked', false);
        
        const today = new Date().toISOString().split('T')[0];
        $('#publishDate').val(today);
        $('#expireDate').val('');
    }

    // 뒤로가기
    function goBack() {
        window.history.back();
    }

    // 공지사항 목록 보기
    function viewNoticeList() {
        window.location.href = 'student-notice.html';
    }

    // 토스트 메시지 표시
    function showToast(message) {
        const toastBody = document.querySelector('.toast-body');
        toastBody.textContent = message;
        
        const toast = new bootstrap.Toast(document.getElementById('draftToast'));
        toast.show();
    }
</script>
</body>
</html>
